function S = MakeTestData(W)

% MAKETESTDATA make test similarity matrix
% S = MAKETESTDATA(W) creates a synthetic similarity matrix S 
% which has a two-layer hierarchy, given the parameters in struct W:
%       W.N   : number of groups at the bottom of the hierarchy (even number)
%       W.size : size of each group at bottom of hierarchy (S is (size  x N))
%       W.within1.m : mean weight within the 1st layer groups 
%       W.within1.s : SD weight within the 1st layer groups
%       W.within2.m : mean weight within the 2nd layer groups (and between
%       the 1st layer groups)
%       W.within2.s : SD weight within the 2nd layer groups
%       W.between.m : mean weight between the 2nd layer groups
%       W.between.s : sd weight between the 2nd layer groups
%        
% Constructs a two-layer hierarchy:
%       - W.N groups at the bottom, connected within by .within1.
%       - 2 groups above (each W.N/2 in size), connected within by
%       .within2.
%       
%
% 26/11/2018: initial version
% Mark Humphries

% limits on entries - here assuming similarity in [0,1]
l = 0;
u = 1;

% catch errors
if mod(W.N,2) ~=0 
       error('Even number of groups needed')
end

% warn of unusual choices
if W.within1.m < W.within2.m
    warning('Internal weight of layer 1 smaller the between weight of layer 1')
end

if W.within1.m < W.between.m
    warning('Internal weight of layer 1 smaller the between weight layers')
end

%% initialise
n = W.size * W.N;
S = zeros(n);


keyboard

%% build layer 1
maskWithin1up = zeros(n); 
% indices of within layer 1
for i = 1:W.N
    ixs = (W.size *(i-1)+1):i*W.size;
    maskWithin1up(ixs,ixs) = 1; 
end
maskWithin1up = triu(maskWithin1up,1);

% sample truncated Gaussian weights
% X=trandn((l-m)/s,(u-m)/s) and set Z=m+s*X;
Nnz = sum(maskWithin1up(:));
z = trandn(ones(Nnz,1)*L,ones(Nnz,1)*U);
Z = W.within1.m +  W.within1.s * z;

S(maskWithin1up == 1) = Z;
S = S + S';  % make symmetric

%% build layer 2
for i = 1:W.N
    ixs1 = (W.size *(i-1)+1):i*W.size;
    maskWithin2(ixs,ixs) = 1; 
end
maskWithin1up = triu(maskWithin1up,1);

%% put 1s on diagonal!
S(eye(n)==1) = 1;